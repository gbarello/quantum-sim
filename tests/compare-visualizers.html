<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizer Comparison - Original vs VisualizerV2</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #fff;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #4fc3f7;
    }

    .description {
      text-align: center;
      margin-bottom: 20px;
      color: #aaa;
      font-size: 14px;
    }

    .controls {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .control-group {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-group label {
      font-size: 14px;
      color: #ccc;
    }

    .control-group button {
      padding: 8px 16px;
      background: #4fc3f7;
      border: none;
      border-radius: 4px;
      color: #000;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }

    .control-group button:hover {
      background: #6dd5ff;
    }

    .control-group select {
      padding: 8px 12px;
      background: #3a3a3a;
      border: 1px solid #555;
      border-radius: 4px;
      color: #fff;
      font-size: 14px;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .visualizer-panel {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 15px;
    }

    .visualizer-panel h2 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #4fc3f7;
    }

    .canvas-container {
      position: relative;
      background: #000;
      border-radius: 4px;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .canvas-container canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .stats {
      margin-top: 10px;
      font-size: 12px;
      color: #aaa;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .stat-item {
      background: #1a1a1a;
      padding: 8px;
      border-radius: 4px;
    }

    .stat-label {
      color: #888;
      display: block;
      font-size: 11px;
    }

    .stat-value {
      color: #4fc3f7;
      font-weight: 600;
      font-size: 14px;
    }

    .difference {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 15px;
    }

    .difference h2 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #ff9800;
    }

    .diff-canvas {
      background: #000;
      border-radius: 4px;
      width: 100%;
      display: block;
    }

    .diff-stats {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .status {
      margin-top: 10px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
    }

    .status.identical {
      background: #2e7d32;
      color: #fff;
    }

    .status.different {
      background: #d32f2f;
      color: #fff;
    }

    .instructions {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .instructions h3 {
      margin-bottom: 10px;
      color: #4fc3f7;
      font-size: 16px;
    }

    .instructions ul {
      margin-left: 20px;
      color: #aaa;
      font-size: 14px;
      line-height: 1.6;
    }

    @media (max-width: 1024px) {
      .comparison {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visualizer Comparison Tool</h1>
    <p class="description">
      Side-by-side comparison of Original Visualizer vs VisualizerV2
    </p>

    <div class="instructions">
      <h3>Instructions</h3>
      <ul>
        <li>Both visualizers render the same quantum state simultaneously</li>
        <li>Use controls to test different visualization modes and features</li>
        <li>The difference panel shows pixel-by-pixel comparison (amplified 10x)</li>
        <li>Both implementations should be pixel-perfect identical (green status)</li>
        <li>If differences appear (red status), investigate the cause</li>
      </ul>
    </div>

    <div class="controls">
      <div class="control-group">
        <button id="btnReset">Reset Simulation</button>
        <button id="btnStep">Step Physics</button>
        <button id="btnMeasure">Trigger Measurement</button>

        <label for="vizMode">Mode:</label>
        <select id="vizMode">
          <option value="full">Full (Complex)</option>
          <option value="probability">Probability</option>
          <option value="phase">Phase</option>
        </select>

        <label for="satScale">Saturation:</label>
        <select id="satScale">
          <option value="1">1x</option>
          <option value="5" selected>5x</option>
          <option value="10">10x</option>
        </select>

        <label><input type="checkbox" id="chkGrid"> Grid</label>
        <label><input type="checkbox" id="chkWheel"> Phase Wheel</label>
      </div>
    </div>

    <div class="comparison">
      <div class="visualizer-panel">
        <h2>Original Visualizer (Legacy)</h2>
        <div class="canvas-container">
          <canvas id="canvasOriginal"></canvas>
        </div>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-label">Render Time</span>
            <span class="stat-value" id="timeOriginal">-</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">File Size</span>
            <span class="stat-value">726 lines</span>
          </div>
        </div>
      </div>

      <div class="visualizer-panel">
        <h2>VisualizerV2 (New Panel-Based)</h2>
        <div class="canvas-container">
          <canvas id="canvasV2"></canvas>
        </div>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-label">Render Time</span>
            <span class="stat-value" id="timeV2">-</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">File Size</span>
            <span class="stat-value">~330 lines</span>
          </div>
        </div>
      </div>
    </div>

    <div class="difference">
      <h2>Pixel Difference (Amplified 10x)</h2>
      <canvas id="canvasDiff"></canvas>
      <div class="diff-stats">
        <div class="stat-item">
          <span class="stat-label">Different Pixels</span>
          <span class="stat-value" id="diffPixels">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Max Difference</span>
          <span class="stat-value" id="maxDiff">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Avg Difference</span>
          <span class="stat-value" id="avgDiff">-</span>
        </div>
      </div>
      <div id="status" class="status">Initializing...</div>
    </div>
  </div>

  <script type="module">
    import { Visualizer } from '../js/visualization.js';
    import { VisualizerV2 } from '../js/visualization/VisualizerV2.js';
    import { QuantumSimulation } from '../js/quantum.js';

    // Create simulation (shared by both visualizers)
    const simulation = new QuantumSimulation({
      gridSize: 128,
      domainSize: 10.0,
      dt: 0.01,
      boundaryCondition: 'periodic'
    });

    // Initialize with a Gaussian wavepacket
    simulation.initialize({
      centerX: 64,
      centerY: 64,
      width: 0.6,
      momentumX: 1.0,
      momentumY: 0.5
    });

    // Create canvases
    const canvasOriginal = document.getElementById('canvasOriginal');
    const canvasV2 = document.getElementById('canvasV2');
    const canvasDiff = document.getElementById('canvasDiff');

    // Set canvas sizes
    const canvasSize = 600;
    [canvasOriginal, canvasV2, canvasDiff].forEach(canvas => {
      canvas.width = canvasSize;
      canvas.height = canvasSize;
    });

    // Create visualizers
    const vizOriginal = new Visualizer(canvasOriginal, simulation);
    const vizV2 = new VisualizerV2(canvasV2, simulation);

    // Get controls
    const btnReset = document.getElementById('btnReset');
    const btnStep = document.getElementById('btnStep');
    const btnMeasure = document.getElementById('btnMeasure');
    const vizMode = document.getElementById('vizMode');
    const satScale = document.getElementById('satScale');
    const chkGrid = document.getElementById('chkGrid');
    const chkWheel = document.getElementById('chkWheel');

    // Render function
    function render() {
      // Render original
      const t1 = performance.now();
      vizOriginal.render();
      const t2 = performance.now();
      document.getElementById('timeOriginal').textContent = `${(t2 - t1).toFixed(2)}ms`;

      // Render V2
      const t3 = performance.now();
      vizV2.render();
      const t4 = performance.now();
      document.getElementById('timeV2').textContent = `${(t4 - t3).toFixed(2)}ms`;

      // Compare
      compareCanvases();
    }

    // Compare canvases pixel-by-pixel
    function compareCanvases() {
      const ctx1 = canvasOriginal.getContext('2d');
      const ctx2 = canvasV2.getContext('2d');
      const ctxDiff = canvasDiff.getContext('2d');

      const data1 = ctx1.getImageData(0, 0, canvasSize, canvasSize).data;
      const data2 = ctx2.getImageData(0, 0, canvasSize, canvasSize).data;
      const dataDiff = ctxDiff.createImageData(canvasSize, canvasSize);

      let totalDiff = 0;
      let maxDiff = 0;
      let diffPixels = 0;

      for (let i = 0; i < data1.length; i += 4) {
        const dr = Math.abs(data1[i] - data2[i]);
        const dg = Math.abs(data1[i + 1] - data2[i + 1]);
        const db = Math.abs(data1[i + 2] - data2[i + 2]);
        const diff = (dr + dg + db) / 3;

        totalDiff += diff;
        maxDiff = Math.max(maxDiff, diff);

        if (diff > 1) {
          diffPixels++;
        }

        // Amplify difference for visibility (10x)
        const amplified = Math.min(255, diff * 10);
        dataDiff.data[i] = amplified;
        dataDiff.data[i + 1] = amplified;
        dataDiff.data[i + 2] = amplified;
        dataDiff.data[i + 3] = 255;
      }

      ctxDiff.putImageData(dataDiff, 0, 0);

      const avgDiff = totalDiff / (data1.length / 4);

      // Update stats
      document.getElementById('diffPixels').textContent = diffPixels.toLocaleString();
      document.getElementById('maxDiff').textContent = maxDiff.toFixed(2);
      document.getElementById('avgDiff').textContent = avgDiff.toFixed(4);

      // Update status
      const status = document.getElementById('status');
      if (avgDiff < 0.1 && maxDiff < 2) {
        status.textContent = '✓ Identical - Perfect match!';
        status.className = 'status identical';
      } else {
        status.textContent = `✗ Different - Avg: ${avgDiff.toFixed(2)}, Max: ${maxDiff.toFixed(0)}`;
        status.className = 'status different';
      }
    }

    // Event handlers
    btnReset.addEventListener('click', () => {
      simulation.initialize({
        centerX: 64,
        centerY: 64,
        width: 0.6,
        momentumX: 1.0,
        momentumY: 0.5
      });
      render();
    });

    btnStep.addEventListener('click', () => {
      for (let i = 0; i < 5; i++) {
        simulation.step();
      }
      render();
    });

    btnMeasure.addEventListener('click', () => {
      const x = Math.floor(Math.random() * simulation.gridSize);
      const y = Math.floor(Math.random() * simulation.gridSize);
      const result = simulation.measure(x, y);

      vizOriginal.showMeasurementFeedback(x, y, result.found ? 'positive' : 'negative');
      vizV2.showMeasurementFeedback(x, y, result.found ? 'positive' : 'negative');

      render();
    });

    vizMode.addEventListener('change', (e) => {
      vizOriginal.setVisualizationMode(e.target.value);
      vizV2.setVisualizationMode(e.target.value);
      render();
    });

    satScale.addEventListener('change', (e) => {
      const scale = parseFloat(e.target.value);
      vizOriginal.setSaturationScale(scale);
      vizV2.setSaturationScale(scale);
      render();
    });

    chkGrid.addEventListener('change', (e) => {
      vizOriginal.setGridVisible(e.target.checked);
      vizV2.setGridVisible(e.target.checked);
      render();
    });

    chkWheel.addEventListener('change', (e) => {
      vizOriginal.setPhaseWheelVisible(e.target.checked);
      vizV2.setPhaseWheelVisible(e.target.checked);
      render();
    });

    // Initial render
    render();

    // Auto-update for animation testing
    let autoUpdate = false;
    document.addEventListener('keydown', (e) => {
      if (e.key === ' ') {
        autoUpdate = !autoUpdate;
        if (autoUpdate) {
          animate();
        }
      }
    });

    function animate() {
      if (!autoUpdate) return;

      for (let i = 0; i < 3; i++) {
        simulation.step();
      }
      render();

      requestAnimationFrame(animate);
    }

    console.log('Visualizer Comparison Tool Ready');
    console.log('Press SPACE to toggle auto-animation');
  </script>
</body>
</html>
