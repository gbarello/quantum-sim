<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Panels Visual Tests</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .test-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: #000;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button:active {
            transform: translateY(1px);
        }

        .info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin-top: 15px;
            border-radius: 3px;
        }

        .info h3 {
            color: #1976d2;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .info p {
            color: #555;
            font-size: 0.9em;
            margin: 0;
        }

        #test-results {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.pass {
            background: #4caf50;
            color: white;
        }

        .status.fail {
            background: #f44336;
            color: white;
        }

        .grid-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-wrapper {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Overlay Panels Visual Tests</h1>
        <p class="subtitle">Interactive demonstrations of all overlay panel components</p>

        <!-- Unit Tests Section -->
        <div class="test-section">
            <h2>Unit Tests</h2>
            <p class="test-description">
                Automated unit tests for all overlay panels. Click the button to run tests.
            </p>
            <button id="run-tests">Run Unit Tests</button>
            <div id="test-results"></div>
        </div>

        <!-- Grid Overlay Test -->
        <div class="test-section">
            <h2>1. Grid Overlay Panel</h2>
            <p class="test-description">
                Demonstrates the grid overlay that draws lines over the wavefunction visualization.
                The grid helps users identify positions and understand the discrete simulation grid.
            </p>
            <div class="canvas-container">
                <canvas id="grid-canvas" width="512" height="512"></canvas>
            </div>
            <div class="controls">
                <button id="toggle-grid">Toggle Grid</button>
                <button id="change-grid-color">Change Color</button>
                <button id="change-grid-width">Change Width</button>
            </div>
            <div class="info">
                <h3>What to look for:</h3>
                <p>✓ Grid lines align with cells<br>
                   ✓ Lines are semi-transparent<br>
                   ✓ Both horizontal and vertical lines are drawn</p>
            </div>
        </div>

        <!-- Measurement Feedback Test -->
        <div class="test-section">
            <h2>2. Measurement Feedback Panel</h2>
            <p class="test-description">
                Demonstrates the animated feedback shown after a quantum measurement.
                Green indicates a successful measurement (particle found), red indicates no particle found.
            </p>
            <div class="canvas-container">
                <canvas id="feedback-canvas" width="512" height="512"></canvas>
            </div>
            <div class="controls">
                <button id="positive-feedback">Show Positive Feedback</button>
                <button id="negative-feedback">Show Negative Feedback</button>
                <button id="random-feedback">Random Feedback</button>
            </div>
            <div class="info">
                <h3>What to look for:</h3>
                <p>✓ Colored rectangle fades out over time<br>
                   ✓ Positive feedback shows expanding green circle<br>
                   ✓ Negative feedback shows red flash only<br>
                   ✓ Animation completes after ~500ms</p>
            </div>
        </div>

        <!-- Measurement Circle Test -->
        <div class="test-section">
            <h2>3. Measurement Circle Panel</h2>
            <p class="test-description">
                Demonstrates the red circle that shows the measurement radius when hovering.
                Move your mouse over the canvas to see the circle follow.
            </p>
            <div class="canvas-container">
                <canvas id="circle-canvas" width="512" height="512"></canvas>
            </div>
            <div class="controls">
                <button id="increase-radius">Increase Radius</button>
                <button id="decrease-radius">Decrease Radius</button>
            </div>
            <div class="info">
                <h3>What to look for:</h3>
                <p>✓ Red circle follows mouse position<br>
                   ✓ Circle centered at grid cell center<br>
                   ✓ Circle disappears when mouse leaves canvas<br>
                   ✓ Radius adjusts based on settings</p>
            </div>
        </div>

        <!-- Phase Wheel Test -->
        <div class="test-section">
            <h2>4. Phase Wheel Panel</h2>
            <p class="test-description">
                Demonstrates the phase wheel color legend that shows how complex phase maps to colors.
                This helps users interpret the wavefunction visualization colors.
            </p>
            <div class="canvas-container">
                <canvas id="wheel-canvas" width="800" height="600"></canvas>
            </div>
            <div class="info">
                <h3>What to look for:</h3>
                <p>✓ Full 360° color wheel<br>
                   ✓ Labels at key angles: Re+ (red), Im+ (yellow), Re- (cyan), Im- (blue)<br>
                   ✓ White border around wheel<br>
                   ✓ Smooth color transitions</p>
            </div>
        </div>

        <!-- All Panels Combined -->
        <div class="test-section">
            <h2>5. All Panels Combined</h2>
            <p class="test-description">
                Demonstrates all overlay panels working together on the same canvas.
                This simulates how they would appear in the full application.
            </p>
            <div class="canvas-container">
                <canvas id="combined-canvas" width="800" height="600"></canvas>
            </div>
            <div class="controls">
                <button id="combined-measurement">Trigger Measurement</button>
                <button id="toggle-combined-grid">Toggle Grid</button>
                <button id="toggle-wheel">Toggle Phase Wheel</button>
            </div>
            <div class="info">
                <h3>What to look for:</h3>
                <p>✓ All overlays render correctly<br>
                   ✓ No visual interference between overlays<br>
                   ✓ Animations work smoothly together<br>
                   ✓ Hover circle appears over other overlays</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { GridOverlayPanel } from '../js/visualization/panels/GridOverlayPanel.js';
        import { MeasurementFeedbackPanel } from '../js/visualization/panels/MeasurementFeedbackPanel.js';
        import { MeasurementCirclePanel } from '../js/visualization/panels/MeasurementCirclePanel.js';
        import { PhaseWheelPanel } from '../js/visualization/panels/PhaseWheelPanel.js';

        // Mock simulation
        const mockSimulation = {
            gridSize: 128,
            measurementRadius: 0.2,  // Physical units (default)
            dx: 0.02                  // Spatial step size
        };

        // Helper to create gradient background
        function drawGradientBackground(ctx, width, height) {
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
        }

        // ===== Test 1: Grid Overlay =====
        const gridCanvas = document.getElementById('grid-canvas');
        const gridCtx = gridCanvas.getContext('2d');
        const gridPanel = new GridOverlayPanel(
            { x: 0, y: 0, width: 512, height: 512 },
            128
        );

        let gridVisible = true;
        let gridColorIndex = 0;
        const gridColors = [
            'rgba(255, 255, 255, 0.2)',
            'rgba(0, 255, 0, 0.3)',
            'rgba(255, 0, 0, 0.3)',
            'rgba(0, 255, 255, 0.3)'
        ];
        let gridWidthIndex = 0;
        const gridWidths = [1, 2, 3, 1];

        function renderGrid() {
            drawGradientBackground(gridCtx, 512, 512);
            if (gridVisible) {
                gridPanel.render(gridCtx, mockSimulation, performance.now());
            }
        }

        document.getElementById('toggle-grid').addEventListener('click', () => {
            gridVisible = !gridVisible;
            renderGrid();
        });

        document.getElementById('change-grid-color').addEventListener('click', () => {
            gridColorIndex = (gridColorIndex + 1) % gridColors.length;
            gridPanel.setLineColor(gridColors[gridColorIndex]);
            renderGrid();
        });

        document.getElementById('change-grid-width').addEventListener('click', () => {
            gridWidthIndex = (gridWidthIndex + 1) % gridWidths.length;
            gridPanel.setLineWidth(gridWidths[gridWidthIndex]);
            renderGrid();
        });

        renderGrid();

        // ===== Test 2: Measurement Feedback =====
        const feedbackCanvas = document.getElementById('feedback-canvas');
        const feedbackCtx = feedbackCanvas.getContext('2d');
        const feedbackPanel = new MeasurementFeedbackPanel(
            { x: 0, y: 0, width: 512, height: 512 },
            128
        );

        function animateFeedback() {
            drawGradientBackground(feedbackCtx, 512, 512);
            feedbackPanel.render(feedbackCtx, mockSimulation, performance.now());
            requestAnimationFrame(animateFeedback);
        }
        animateFeedback();

        document.getElementById('positive-feedback').addEventListener('click', () => {
            feedbackPanel.showFeedback(64, 64, 'positive', 500);
        });

        document.getElementById('negative-feedback').addEventListener('click', () => {
            feedbackPanel.showFeedback(96, 32, 'negative', 500);
        });

        document.getElementById('random-feedback').addEventListener('click', () => {
            const x = Math.floor(Math.random() * 128);
            const y = Math.floor(Math.random() * 128);
            const type = Math.random() > 0.5 ? 'positive' : 'negative';
            feedbackPanel.showFeedback(x, y, type, 500);
        });

        // ===== Test 3: Measurement Circle =====
        const circleCanvas = document.getElementById('circle-canvas');
        const circleCtx = circleCanvas.getContext('2d');
        const circlePanel = new MeasurementCirclePanel(
            { x: 0, y: 0, width: 512, height: 512 },
            128
        );

        let circleRadius = 10;  // In grid units (for slider)

        function renderCircle() {
            drawGradientBackground(circleCtx, 512, 512);
            // Convert circleRadius (grid units) to physical units for the simulation
            const physicalRadius = circleRadius * mockSimulation.dx;
            circlePanel.render(circleCtx, { ...mockSimulation, measurementRadius: physicalRadius }, performance.now());
            requestAnimationFrame(renderCircle);
        }
        renderCircle();

        circleCanvas.addEventListener('mousemove', (e) => {
            const rect = circleCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const cellSize = 512 / 128;
            const gridX = Math.floor(x / cellSize);
            const gridY = Math.floor(y / cellSize);
            circlePanel.setHoverState(true, gridX, gridY);
        });

        circleCanvas.addEventListener('mouseleave', () => {
            circlePanel.setHoverState(false);
        });

        document.getElementById('increase-radius').addEventListener('click', () => {
            circleRadius = Math.min(30, circleRadius + 5);
        });

        document.getElementById('decrease-radius').addEventListener('click', () => {
            circleRadius = Math.max(5, circleRadius - 5);
        });

        // ===== Test 4: Phase Wheel =====
        const wheelCanvas = document.getElementById('wheel-canvas');
        const wheelCtx = wheelCanvas.getContext('2d');
        const wheelPanel = new PhaseWheelPanel({
            x: 360, y: 260, width: 80, height: 80
        });

        function renderWheel() {
            drawGradientBackground(wheelCtx, 800, 600);
            wheelPanel.render(wheelCtx, mockSimulation, performance.now());
        }
        renderWheel();

        // ===== Test 5: All Panels Combined =====
        const combinedCanvas = document.getElementById('combined-canvas');
        const combinedCtx = combinedCanvas.getContext('2d');

        const combinedGrid = new GridOverlayPanel({ x: 0, y: 0, width: 600, height: 600 }, 128);
        const combinedFeedback = new MeasurementFeedbackPanel({ x: 0, y: 0, width: 600, height: 600 }, 128);
        const combinedCircle = new MeasurementCirclePanel({ x: 0, y: 0, width: 600, height: 600 }, 128);
        const combinedWheel = new PhaseWheelPanel({ x: 700, y: 260, width: 80, height: 80 });

        let combinedGridVisible = true;
        let combinedWheelVisible = true;

        function renderCombined() {
            drawGradientBackground(combinedCtx, 800, 600);
            if (combinedGridVisible) {
                combinedGrid.render(combinedCtx, mockSimulation, performance.now());
            }
            combinedFeedback.render(combinedCtx, mockSimulation, performance.now());
            combinedCircle.render(combinedCtx, mockSimulation, performance.now());
            if (combinedWheelVisible) {
                combinedWheel.render(combinedCtx, mockSimulation, performance.now());
            }
            requestAnimationFrame(renderCombined);
        }
        renderCombined();

        combinedCanvas.addEventListener('mousemove', (e) => {
            const rect = combinedCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (x < 600 && y < 600) {
                const cellSize = 600 / 128;
                const gridX = Math.floor(x / cellSize);
                const gridY = Math.floor(y / cellSize);
                combinedCircle.setHoverState(true, gridX, gridY);
            } else {
                combinedCircle.setHoverState(false);
            }
        });

        combinedCanvas.addEventListener('mouseleave', () => {
            combinedCircle.setHoverState(false);
        });

        document.getElementById('combined-measurement').addEventListener('click', () => {
            const x = Math.floor(Math.random() * 128);
            const y = Math.floor(Math.random() * 128);
            const type = Math.random() > 0.5 ? 'positive' : 'negative';
            combinedFeedback.showFeedback(x, y, type, 500);
        });

        document.getElementById('toggle-combined-grid').addEventListener('click', () => {
            combinedGridVisible = !combinedGridVisible;
        });

        document.getElementById('toggle-wheel').addEventListener('click', () => {
            combinedWheelVisible = !combinedWheelVisible;
        });

        // ===== Run Unit Tests =====
        document.getElementById('run-tests').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.textContent = 'Running tests...\n';

            // Import and run tests
            const testModule = await import('./test-overlay-panels.js');

            // Capture console output
            const originalLog = console.log;
            const originalError = console.error;
            let output = '';

            console.log = (...args) => {
                output += args.join(' ') + '\n';
                originalLog(...args);
            };

            console.error = (...args) => {
                output += '[ERROR] ' + args.join(' ') + '\n';
                originalError(...args);
            };

            // Give time for tests to run
            setTimeout(() => {
                console.log = originalLog;
                console.error = originalError;
                resultsDiv.textContent = output;
            }, 100);
        });
    </script>
</body>
</html>
