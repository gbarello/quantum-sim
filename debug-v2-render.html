<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VisualizerV2 Debug</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #222;
      color: #fff;
      font-family: monospace;
    }
    #canvas {
      border: 2px solid #0f0;
      display: block;
      margin: 20px 0;
    }
    #log {
      background: #000;
      padding: 10px;
      max-height: 400px;
      overflow-y: scroll;
      border: 1px solid #444;
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    .info { color: #0ff; }
  </style>
</head>
<body>
  <h1>VisualizerV2 Rendering Debug</h1>
  <canvas id="canvas" width="600" height="600"></canvas>
  <h2>Debug Log:</h2>
  <div id="log"></div>

  <script type="module">
    import { QuantumSimulation } from './js/quantum.js';
    import { VisualizerV2 } from './js/visualization/VisualizerV2.js';

    const log = document.getElementById('log');
    function addLog(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
      console.log(msg);
    }

    try {
      addLog('Initializing quantum simulation...', 'info');
      const config = {
        gridSize: 128,
        domainSize: 10.0,
        dt: 0.01,
        timeScale: 1.0,
        stepsPerFrame: 5,
        boundaryCondition: 'periodic'
      };

      const simulation = new QuantumSimulation(config);
      addLog(`Simulation created: gridSize=${simulation.gridSize}`, 'success');

      // Initialize with a simple gaussian
      simulation.initialize({
        centerX: 64,
        centerY: 64,
        width: 0.6,
        momentumX: 1.0,
        momentumY: 0.5
      });
      addLog('Simulation initialized with Gaussian wavepacket', 'success');

      // Check normalization
      const norm = simulation.getTotalProbability();
      addLog(`Total probability: ${norm.toFixed(8)} (should be ~1.0)`, norm > 0.99 && norm < 1.01 ? 'success' : 'error');

      // Create visualizer
      const canvas = document.getElementById('canvas');
      addLog('Creating VisualizerV2...', 'info');

      const visualizer = new VisualizerV2(canvas, simulation, {
        visualizationMode: 'full',
        saturationScale: 5.0,
        showGrid: false,
        showPhaseWheel: false,
        showPotentialPlot: false
      });
      addLog('VisualizerV2 created', 'success');

      // Log canvas dimensions
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      addLog(`Canvas logical: ${visualizer.width}x${visualizer.height}`, 'info');
      addLog(`Canvas physical: ${canvas.width}x${canvas.height}`, 'info');
      addLog(`Device pixel ratio: ${dpr}`, 'info');

      // Log layout
      if (visualizer.layout) {
        const layout = visualizer.layout.calculateLayout();
        addLog(`Wavefunction bounds: x=${layout.wavefunction.x}, y=${layout.wavefunction.y}, w=${layout.wavefunction.width}, h=${layout.wavefunction.height}`, 'info');
      }

      // Sample some wavefunction values
      addLog('Sampling wavefunction values:', 'info');
      for (let i = 0; i < 5; i++) {
        const x = Math.floor(Math.random() * simulation.gridSize);
        const y = Math.floor(Math.random() * simulation.gridSize);
        const re = simulation.psi.getRe(x, y);
        const im = simulation.psi.getIm(x, y);
        const mag = Math.sqrt(re*re + im*im);
        addLog(`  psi[${x},${y}] = ${re.toFixed(4)} + ${im.toFixed(4)}i, |psi| = ${mag.toFixed(4)}`, 'info');
      }

      // Render once
      addLog('Rendering...', 'info');
      visualizer.render();
      addLog('Render complete!', 'success');

      // Check if anything was drawn (sample pixels)
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      let nonBlackPixels = 0;
      let whitePixels = 0;
      let coloredPixels = 0;
      const sampleSize = 10000;

      for (let i = 0; i < sampleSize; i++) {
        const idx = Math.floor(Math.random() * (data.length / 4)) * 4;
        const r = data[idx];
        const g = data[idx + 1];
        const b = data[idx + 2];

        if (r > 0 || g > 0 || b > 0) {
          nonBlackPixels++;
          if (r > 250 && g > 250 && b > 250) {
            whitePixels++;
          } else {
            coloredPixels++;
          }
        }
      }

      addLog(`Pixel sampling (${sampleSize} samples):`, 'info');
      addLog(`  Non-black: ${nonBlackPixels} (${(nonBlackPixels/sampleSize*100).toFixed(1)}%)`, nonBlackPixels > 0 ? 'success' : 'error');
      addLog(`  White: ${whitePixels} (${(whitePixels/sampleSize*100).toFixed(1)}%)`, 'info');
      addLog(`  Colored: ${coloredPixels} (${(coloredPixels/sampleSize*100).toFixed(1)}%)`, coloredPixels > 0 ? 'success' : 'error');

      if (coloredPixels > sampleSize * 0.1) {
        addLog('SUCCESS: Colorful wavefunction is visible!', 'success');
      } else if (whitePixels > sampleSize * 0.5) {
        addLog('ERROR: Canvas is mostly white (ImageData issue)', 'error');
      } else {
        addLog('ERROR: Canvas is mostly black (nothing rendered)', 'error');
      }

    } catch (e) {
      addLog(`ERROR: ${e.message}`, 'error');
      addLog(`Stack: ${e.stack}`, 'error');
    }
  </script>
</body>
</html>
