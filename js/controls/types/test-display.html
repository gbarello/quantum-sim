<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DisplayControl Browser Test</title>

  <!-- Link to controls CSS -->
  <link rel="stylesheet" href="../styles/controls.css">

  <!-- Main app styles for CSS variables -->
  <link rel="stylesheet" href="../../../styles.css">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
      background-color: var(--bg-light, #f5f7fa);
      color: var(--text-color, #2c3e50);
    }

    .test-section {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: var(--accent-color, #3498db);
      margin-bottom: 2rem;
    }

    h2 {
      font-size: 1.25rem;
      color: var(--text-color, #2c3e50);
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border-color, #dfe6e9);
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .test-button {
      padding: 0.5rem 1rem;
      background: var(--accent-color, #3498db);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: background 0.2s;
    }

    .test-button:hover {
      background: var(--accent-hover, #2980b9);
    }

    .display-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .status {
      padding: 0.75rem;
      margin: 1rem 0;
      border-radius: 4px;
      background: var(--bg-dark, #ecf0f1);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }

    .info {
      padding: 1rem;
      margin: 1rem 0;
      border-left: 4px solid var(--accent-color, #3498db);
      background: rgba(52, 152, 219, 0.05);
      font-size: 0.875rem;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <h1>DisplayControl Browser Test</h1>

  <div class="test-section">
    <h2>Test 1: Basic Display Controls</h2>
    <div id="basic-displays"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Statistics Dashboard (from defaultConfig.js)</h2>
    <div class="info">
      These are the actual display controls from the Statistics tab configuration.
    </div>
    <div id="stats-displays" class="display-grid"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Auto-Update Display</h2>
    <div class="info">
      This display automatically updates every 100ms using a simulated data source.
    </div>
    <div id="auto-update-display"></div>
    <div class="button-group">
      <button id="start-auto" class="test-button">Start Auto-Update</button>
      <button id="stop-auto" class="test-button">Stop Auto-Update</button>
    </div>
    <div id="auto-status" class="status">Status: Stopped</div>
  </div>

  <div class="test-section">
    <h2>Test 4: Interactive Controls</h2>
    <div class="info">
      Test enable/disable and show/hide functionality.
    </div>
    <div id="interactive-display"></div>
    <div class="button-group">
      <button id="toggle-enable" class="test-button">Toggle Enable</button>
      <button id="toggle-visible" class="test-button">Toggle Visible</button>
      <button id="update-value" class="test-button">Update Value</button>
    </div>
  </div>

  <script type="module">
    import { DisplayControl } from './DisplayControl.js';
    import { ControlRegistry } from '../ControlRegistry.js';

    console.log('DisplayControl Browser Test Started');

    // Test 1: Basic Display Controls
    const basicContainer = document.getElementById('basic-displays');

    const simpleDisplay = new DisplayControl({
      id: 'simple-display',
      label: 'Simple Value',
      value: 42,
      format: (val) => val.toString()
    });
    simpleDisplay.render(basicContainer);

    const percentDisplay = new DisplayControl({
      id: 'percent-display',
      label: 'Percentage',
      value: 0.856,
      format: (val) => `${(val * 100).toFixed(1)}%`
    });
    percentDisplay.render(basicContainer);

    const unitDisplay = new DisplayControl({
      id: 'unit-display',
      label: 'With Unit',
      value: 299.792,
      unit: 'km/s',
      format: (val) => val.toFixed(3)
    });
    unitDisplay.render(basicContainer);

    // Test 2: Statistics Dashboard (from defaultConfig.js)
    const statsContainer = document.getElementById('stats-displays');

    const statsDisplays = [
      {
        id: 'total-probability',
        label: 'Total Probability',
        value: 1.0,
        format: (val) => {
          if (typeof val !== 'number') return '—';
          return `${(val * 100).toFixed(4)}%`;
        },
        className: 'stat-display'
      },
      {
        id: 'time-elapsed',
        label: 'Time Elapsed',
        value: 12.34,
        format: (val) => {
          if (typeof val !== 'number') return '—';
          return `${val.toFixed(2)} s`;
        },
        className: 'stat-display'
      },
      {
        id: 'grid-size',
        label: 'Grid Size',
        value: 128,
        format: (val) => {
          if (typeof val !== 'number') return '—';
          return `${val}×${val}`;
        },
        className: 'stat-display'
      },
      {
        id: 'measurement-count',
        label: 'Measurements',
        value: 5,
        format: (val) => {
          if (typeof val !== 'number') return '—';
          return val.toString();
        },
        className: 'stat-display'
      }
    ];

    const statControls = statsDisplays.map(config => {
      const display = ControlRegistry.create({ type: 'display', ...config });
      display.render(statsContainer);
      return display;
    });

    // Simulate value changes every 2 seconds
    let probValue = 1.0;
    let timeValue = 12.34;
    let measurementValue = 5;

    setInterval(() => {
      probValue = 0.95 + Math.random() * 0.05;
      timeValue += 0.1;
      measurementValue += Math.random() > 0.7 ? 1 : 0;

      statControls[0].setValue(probValue);
      statControls[1].setValue(timeValue);
      statControls[3].setValue(measurementValue);
    }, 2000);

    // Test 3: Auto-Update Display
    const autoContainer = document.getElementById('auto-update-display');
    const autoStatus = document.getElementById('auto-status');

    let autoUpdateEnabled = false;
    let simulatedValue = 0;

    // Mock manager for auto-update
    const mockManager = {
      getSimulatedValue: () => simulatedValue
    };

    const autoDisplay = new DisplayControl({
      id: 'auto-update',
      label: 'Live Counter',
      value: 0,
      format: (val) => val.toString(),
      updateInterval: 100,
      getValue: (manager) => manager.getSimulatedValue()
    });
    autoDisplay.setManager(mockManager);
    autoDisplay.render(autoContainer);

    // Simulate value changes
    let valueInterval = null;

    document.getElementById('start-auto').addEventListener('click', () => {
      if (!autoUpdateEnabled) {
        autoUpdateEnabled = true;
        autoStatus.textContent = 'Status: Running';
        autoStatus.style.background = 'rgba(46, 204, 113, 0.1)';

        // Start incrementing the simulated value
        valueInterval = setInterval(() => {
          simulatedValue++;
        }, 150);
      }
    });

    document.getElementById('stop-auto').addEventListener('click', () => {
      if (autoUpdateEnabled) {
        autoUpdateEnabled = false;
        autoStatus.textContent = 'Status: Stopped';
        autoStatus.style.background = 'var(--bg-dark, #ecf0f1)';

        if (valueInterval) {
          clearInterval(valueInterval);
          valueInterval = null;
        }
      }
    });

    // Test 4: Interactive Controls
    const interactiveContainer = document.getElementById('interactive-display');

    const interactiveDisplay = new DisplayControl({
      id: 'interactive',
      label: 'Interactive Display',
      value: 100,
      format: (val) => val.toFixed(2)
    });
    interactiveDisplay.render(interactiveContainer);

    document.getElementById('toggle-enable').addEventListener('click', () => {
      if (interactiveDisplay.isEnabled()) {
        interactiveDisplay.disable();
      } else {
        interactiveDisplay.enable();
      }
    });

    document.getElementById('toggle-visible').addEventListener('click', () => {
      if (interactiveDisplay.isVisible()) {
        interactiveDisplay.hide();
      } else {
        interactiveDisplay.show();
      }
    });

    let currentValue = 100;
    document.getElementById('update-value').addEventListener('click', () => {
      currentValue += Math.random() * 50 - 25;
      interactiveDisplay.setValue(currentValue);
    });

    console.log('All tests initialized successfully!');
    console.log('DisplayControl is registered:', ControlRegistry.has('display'));
  </script>
</body>
</html>
