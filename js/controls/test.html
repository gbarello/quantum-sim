<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controls System - Phase 1 Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    h2 {
      color: #555;
      margin-top: 30px;
    }

    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .control-wrapper {
      margin: 15px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }

    .control-wrapper.disabled {
      opacity: 0.5;
      pointer-events: none;
      background: #e9ecef;
    }

    .control-label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }

    .control-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .control-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .checkbox-control {
      display: flex;
      align-items: center;
    }

    .checkbox-control input {
      margin-right: 8px;
    }

    .checkbox-control label {
      margin-bottom: 0;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }

    button:hover {
      background: #0056b3;
    }

    button:active {
      transform: translateY(1px);
    }

    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }

    .log-entry.change {
      color: #4fc3f7;
    }

    .log-entry.event {
      color: #81c784;
    }

    .log-entry.error {
      color: #e57373;
    }

    .log-entry.info {
      color: #ffd54f;
    }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h1>Controls System - Phase 1 Test</h1>
  <p>Testing <code>BaseControl</code> and <code>ControlRegistry</code> implementation.</p>

  <div class="test-section">
    <h2>Test 1: Registration & Creation</h2>
    <p>Registering control types and creating instances...</p>
    <div id="test1-output"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Interactive Controls</h2>
    <p>Try interacting with these controls:</p>
    <div id="controls-container"></div>

    <div style="margin-top: 15px;">
      <button id="toggle-btn">Toggle Enable/Disable</button>
      <button id="visibility-btn">Toggle Show/Hide</button>
      <button id="reset-btn">Reset Values</button>
    </div>
  </div>

  <div class="test-section">
    <h2>Test 3: Event System</h2>
    <p>Events from the controls will appear below:</p>
    <div id="event-log" class="log"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Validation</h2>
    <p>Testing configuration validation:</p>
    <div id="validation-output"></div>
  </div>

  <script type="module">
    import { BaseControl } from './BaseControl.js';
    import { ControlRegistry } from './ControlRegistry.js';

    // ========================================================================
    // Define Test Control Types
    // ========================================================================

    class TextControl extends BaseControl {
      constructor(config) {
        super(config);
        this.placeholder = config.placeholder || '';
      }

      render(parentElement) {
        this.container = this._createContainer();
        const label = this._createLabel(this.id);
        const input = document.createElement('input');
        input.type = 'text';
        input.id = this.id;
        input.className = 'control-input';
        input.value = this.defaultValue || '';
        input.placeholder = this.placeholder;

        input.addEventListener('input', () => {
          this.emit('change', input.value);
        });

        this.container.appendChild(label);
        this.container.appendChild(input);

        if (parentElement) {
          parentElement.appendChild(this.container);
        }

        return this.container;
      }

      getValue() {
        return this.container.querySelector('input').value;
      }

      setValue(value) {
        const input = this.container.querySelector('input');
        input.value = value;
        this.emit('change', value);
      }
    }

    class CheckboxControl extends BaseControl {
      render(parentElement) {
        this.container = this._createContainer();
        this.container.className += ' checkbox-control';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = this.id;
        input.className = 'control-checkbox';
        input.checked = this.defaultValue || false;

        const label = document.createElement('label');
        label.setAttribute('for', this.id);
        label.className = 'control-label';
        label.textContent = this.label;

        input.addEventListener('change', () => {
          this.emit('change', input.checked);
        });

        this.container.appendChild(input);
        this.container.appendChild(label);

        if (parentElement) {
          parentElement.appendChild(this.container);
        }

        return this.container;
      }

      getValue() {
        return this.container.querySelector('input').checked;
      }

      setValue(value) {
        const input = this.container.querySelector('input');
        input.checked = !!value;
        this.emit('change', input.checked);
      }
    }

    // ========================================================================
    // Logging Utility
    // ========================================================================

    const logContainer = document.getElementById('event-log');
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // ========================================================================
    // Test 1: Registration & Creation
    // ========================================================================

    function runTest1() {
      const output = document.getElementById('test1-output');
      let html = '';

      try {
        // Register types
        ControlRegistry.register('text', TextControl);
        ControlRegistry.register('checkbox', CheckboxControl);
        html += '<p>✓ Registered control types: <code>' + ControlRegistry.getTypes().join(', ') + '</code></p>';

        // Check registrations
        html += '<p>✓ Has "text": <code>' + ControlRegistry.has('text') + '</code></p>';
        html += '<p>✓ Has "button": <code>' + ControlRegistry.has('button') + '</code></p>';

        // Create a control
        const control = ControlRegistry.create({
          type: 'text',
          id: 'test-input',
          label: 'Test Input'
        });
        html += '<p>✓ Created control: <code>' + control.id + '</code></p>';
        control.destroy();

        html += '<span class="status success">All tests passed</span>';
      } catch (error) {
        html += '<p class="error">✗ Error: ' + error.message + '</p>';
        html += '<span class="status error">Tests failed</span>';
        log('Test 1 Error: ' + error.message, 'error');
      }

      output.innerHTML = html;
    }

    // ========================================================================
    // Test 2: Interactive Controls
    // ========================================================================

    const controls = [];

    function runTest2() {
      const container = document.getElementById('controls-container');

      // Create controls
      const configs = [
        {
          type: 'text',
          id: 'username',
          label: 'Username',
          placeholder: 'Enter your username',
          defaultValue: 'user123'
        },
        {
          type: 'text',
          id: 'email',
          label: 'Email',
          placeholder: 'you@example.com',
          defaultValue: 'user@example.com'
        },
        {
          type: 'checkbox',
          id: 'newsletter',
          label: 'Subscribe to newsletter',
          defaultValue: true
        },
        {
          type: 'checkbox',
          id: 'terms',
          label: 'I agree to the terms and conditions',
          defaultValue: false
        }
      ];

      configs.forEach(config => {
        const control = ControlRegistry.create(config);

        // Add change listener
        control.on('change', (value) => {
          log(`${control.id} changed to: ${value}`, 'change');
        });

        // Render
        control.render(container);
        controls.push(control);
      });

      // Setup buttons
      document.getElementById('toggle-btn').addEventListener('click', () => {
        controls.forEach(c => {
          if (c.isEnabled()) {
            c.disable();
          } else {
            c.enable();
          }
        });
        log('Toggled enable/disable state', 'event');
      });

      document.getElementById('visibility-btn').addEventListener('click', () => {
        controls.forEach(c => {
          if (c.isVisible()) {
            c.hide();
          } else {
            c.show();
          }
        });
        log('Toggled visibility', 'event');
      });

      document.getElementById('reset-btn').addEventListener('click', () => {
        controls.forEach(c => {
          c.setValue(c.defaultValue);
        });
        log('Reset all values to defaults', 'event');
      });
    }

    // ========================================================================
    // Test 4: Validation
    // ========================================================================

    function runTest4() {
      const output = document.getElementById('validation-output');
      let html = '<h3>Valid Configuration:</h3>';

      const validConfig = {
        type: 'text',
        id: 'valid-control',
        label: 'Valid Control'
      };

      const validResult = ControlRegistry.validate(validConfig);
      html += '<p>Result: <code>' + JSON.stringify(validResult) + '</code></p>';

      html += '<h3>Invalid Configuration (missing fields):</h3>';
      const invalidConfig = {
        type: 'text'
        // Missing id and label
      };

      const invalidResult = ControlRegistry.validate(invalidConfig);
      html += '<p>Result: <code>' + JSON.stringify(invalidResult) + '</code></p>';

      html += '<h3>Invalid Configuration (unknown type):</h3>';
      const unknownConfig = {
        type: 'unknown-type',
        id: 'test',
        label: 'Test'
      };

      const unknownResult = ControlRegistry.validate(unknownConfig);
      html += '<p>Result: <code>' + JSON.stringify(unknownResult) + '</code></p>';

      output.innerHTML = html;
    }

    // ========================================================================
    // Run All Tests
    // ========================================================================

    log('Starting Phase 1 tests...', 'info');
    runTest1();
    runTest2();
    runTest4();
    log('All tests initialized', 'info');
  </script>
</body>
</html>
